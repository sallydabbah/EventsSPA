{"id":"node_modules/ro/lib/mqtt/client.js","dependencies":[{"name":"C:\\Users\\ameerzu\\Desktop\\BestWishesTsofen\\EventsSPA\\node_modules\\ro\\lib\\mqtt\\client.js.map","includedInParent":true,"mtime":499162500000},{"name":"C:\\Users\\ameerzu\\Desktop\\BestWishesTsofen\\EventsSPA\\package.json","includedInParent":true,"mtime":1558854526224},{"name":"C:\\Users\\ameerzu\\Desktop\\BestWishesTsofen\\EventsSPA\\node_modules\\ro\\package.json","includedInParent":true,"mtime":1558854523669},{"name":"timers","loc":{"line":2,"column":23},"parent":"C:\\Users\\ameerzu\\Desktop\\BestWishesTsofen\\EventsSPA\\node_modules\\ro\\lib\\mqtt\\client.js","resolved":"C:\\Users\\ameerzu\\Desktop\\BestWishesTsofen\\EventsSPA\\node_modules\\timers-browserify\\main.js"},{"name":"assert","loc":{"line":3,"column":23},"parent":"C:\\Users\\ameerzu\\Desktop\\BestWishesTsofen\\EventsSPA\\node_modules\\ro\\lib\\mqtt\\client.js","resolved":"C:\\Users\\ameerzu\\Desktop\\BestWishesTsofen\\EventsSPA\\node_modules\\assert\\assert.js"},{"name":"util","loc":{"line":4,"column":21},"parent":"C:\\Users\\ameerzu\\Desktop\\BestWishesTsofen\\EventsSPA\\node_modules\\ro\\lib\\mqtt\\client.js","resolved":"C:\\Users\\ameerzu\\Desktop\\BestWishesTsofen\\EventsSPA\\node_modules\\util\\util.js"},{"name":"bluebird","loc":{"line":5,"column":25},"parent":"C:\\Users\\ameerzu\\Desktop\\BestWishesTsofen\\EventsSPA\\node_modules\\ro\\lib\\mqtt\\client.js","resolved":"C:\\Users\\ameerzu\\Desktop\\BestWishesTsofen\\EventsSPA\\node_modules\\bluebird\\js\\browser\\bluebird.js"},{"name":"../client","loc":{"line":6,"column":25},"parent":"C:\\Users\\ameerzu\\Desktop\\BestWishesTsofen\\EventsSPA\\node_modules\\ro\\lib\\mqtt\\client.js","resolved":"C:\\Users\\ameerzu\\Desktop\\BestWishesTsofen\\EventsSPA\\node_modules\\ro\\lib\\client.js"},{"name":"../errors","loc":{"line":7,"column":25},"parent":"C:\\Users\\ameerzu\\Desktop\\BestWishesTsofen\\EventsSPA\\node_modules\\ro\\lib\\mqtt\\client.js","resolved":"C:\\Users\\ameerzu\\Desktop\\BestWishesTsofen\\EventsSPA\\node_modules\\ro\\lib\\errors.js"},{"name":"../utils","loc":{"line":8,"column":24},"parent":"C:\\Users\\ameerzu\\Desktop\\BestWishesTsofen\\EventsSPA\\node_modules\\ro\\lib\\mqtt\\client.js","resolved":"C:\\Users\\ameerzu\\Desktop\\BestWishesTsofen\\EventsSPA\\node_modules\\ro\\lib\\utils.js"},{"name":"mqttr","loc":{"line":38,"column":34},"parent":"C:\\Users\\ameerzu\\Desktop\\BestWishesTsofen\\EventsSPA\\node_modules\\ro\\lib\\mqtt\\client.js","resolved":"C:\\Users\\ameerzu\\Desktop\\BestWishesTsofen\\EventsSPA\\node_modules\\mqttr\\lib\\index.js"},{"name":"pino","loc":{"line":44,"column":40},"parent":"C:\\Users\\ameerzu\\Desktop\\BestWishesTsofen\\EventsSPA\\node_modules\\ro\\lib\\mqtt\\client.js","resolved":"C:\\Users\\ameerzu\\Desktop\\BestWishesTsofen\\EventsSPA\\node_modules\\pino\\browser.js"}],"generated":{"js":"\"use strict\";\nconst timers = require(\"timers\");\nconst assert = require(\"assert\");\nconst util = require(\"util\");\nconst PromiseA = require(\"bluebird\");\nconst client_1 = require(\"../client\");\nconst errors_1 = require(\"../errors\");\nconst utils_1 = require(\"../utils\");\nmodule.exports = class MQTTClient extends client_1.Client {\n    static create(client, options, logger) {\n        return new MQTTClient(client, options, logger);\n    }\n    constructor(client, options, logger) {\n        let opts;\n        if (typeof options === 'string') {\n            opts = { topic: options };\n        }\n        else {\n            opts = options;\n        }\n        assert(opts, '\"options\" is required');\n        assert(opts.topic, '\"opts.topic\" is required');\n        if (opts.timeout == null) {\n            opts.timeout = 100;\n        }\n        opts = Object.assign({\n            qos: 1,\n            logger: {\n                level: 'warn',\n                prettyPrint: {\n                    forceColor: true\n                }\n            }\n        }, opts);\n        super(opts);\n        this.options = opts;\n        if (typeof client === 'string') {\n            this.client = require('mqttr').connect(client, opts);\n            this._owns = true;\n        }\n        else {\n            this.client = client;\n        }\n        this.logger = logger || require('pino')(opts.logger);\n        this.topic = opts.topic;\n        this.subscriptions = {};\n        this.pendings = {};\n        this.idmap = {};\n    }\n    _request(request, options, callback) {\n        const { client } = this;\n        if (typeof options === 'number') {\n            options = { timeout: options };\n        }\n        options = Object.assign({}, this.options, options);\n        const topic = options.topic;\n        const timeout = options.timeout || 0;\n        if (!topic)\n            throw new Error('\"topic\" is required');\n        const ids = request.id ? [request.id] : [];\n        if (Array.isArray(request)) {\n            request.forEach((req) => req.id && ids.push(req.id));\n        }\n        this.ready(() => {\n            if (timeout && ids.length) {\n                const replyTopic = topic + \"/reply\";\n                if (!this.subscriptions[replyTopic]) {\n                    this.logger.debug(\"Subscribing to\", replyTopic);\n                    this.subscriptions[replyTopic] = client.subscribe(replyTopic, (topic, payload) => {\n                        this._handleResponse(topic, payload);\n                    }, { qos: options.qos });\n                }\n            }\n            this.logger.debug(\"< Outgoing to %s : %j\", topic, request);\n            client.publish(topic, request, { qos: options.qos }, () => {\n                if (timeout && ids.length) {\n                    const timer = timers.setTimeout(() => {\n                        if (this.pendings[ids.toString()]) {\n                            callback(new errors_1.TimeoutError({\n                                timeout: timeout,\n                                message: util.format('Timeout of %dms request %s: %j', timeout, topic, request)\n                            }));\n                        }\n                        this._removePending(ids, true);\n                        if (this.logger.isLevelEnabled('debug')) {\n                            this.logger.debug(\"id:%j - Call to service %s - timed out after %d seconds\", ids, topic, timeout / 1000);\n                        }\n                    }, timeout);\n                    ids.forEach(id => this.idmap[id] = ids);\n                    this.pendings[ids.toString()] = {\n                        timer,\n                        done: callback,\n                    };\n                }\n                else {\n                    callback();\n                }\n            });\n        });\n    }\n    ;\n    _handleResponse(topic, payload) {\n        this.logger.debug(\"< Incoming to %s : %j\", topic, payload);\n        let res = payload;\n        if (Array.isArray(payload)) {\n            res = payload.find(item => item.id);\n        }\n        const id = res && res.id;\n        if (!id) {\n            return this.logger.debug(\"Failed to decode reply: %j\", payload);\n        }\n        const ids = this.idmap[id];\n        const pending = this._removePending(ids);\n        if (pending) {\n            pending.done(null, payload);\n        }\n    }\n    ;\n    _removePending(ids, isTimeout) {\n        if (!ids)\n            return;\n        const pending = this.pendings[ids.toString()];\n        if (pending) {\n            if (!isTimeout)\n                clearTimeout(pending.timer);\n            delete this.pendings[ids.toString()];\n            ids.forEach(id => delete this.idmap[id]);\n        }\n        return pending;\n    }\n    ;\n    ready(cb) {\n        return PromiseA.fromCallback(cb => this.client.ready(cb)).asCallback(cb);\n    }\n    ;\n    close(cb) {\n        cb = cb || utils_1.createPromiseCallback();\n        if (this._owns) {\n            this.logger.debug('close mqtt connection');\n            this.client.end(cb);\n        }\n        else {\n            cb();\n        }\n        return cb.promise;\n    }\n    ;\n};\n"},"sourceMaps":{"js":{"version":3,"file":"client.js","sourceRoot":"","sources":["../../src/mqtt/client.ts"],"names":[],"mappings":"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","sourcesContent":[null]}},"error":null,"hash":"1d6de7ecac6529d7328a9a828be2ecfa","cacheData":{"env":{}}}